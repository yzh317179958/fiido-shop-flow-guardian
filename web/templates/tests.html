{% extends "base.html" %}

{% block title %}æµ‹è¯•æ‰§è¡Œ - Fiido æµ‹è¯•å·¥ä½œå°{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="bi bi-play-circle"></i> æµ‹è¯•æ‰§è¡Œ
        </h2>
        <p class="text-muted">é…ç½®å’Œè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•</p>
    </div>
</div>

<!-- æµ‹è¯•é…ç½® -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> æµ‹è¯•é…ç½®
            </div>
            <div class="card-body">
                <form id="test-config-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">æµ‹è¯•èŒƒå›´</label>
                            <select class="form-select" id="test-scope" onchange="updateTestScope()">
                                <option value="all">æ‰€æœ‰å•†å“</option>
                                <option value="priority">æŒ‰ä¼˜å…ˆçº§</option>
                                <option value="category">æŒ‰åˆ†ç±»</option>
                                <option value="product">å•ä¸ªå•†å“</option>
                            </select>
                        </div>

                        <div class="col-md-6" id="priority-select" style="display: none;">
                            <label class="form-label">ä¼˜å…ˆçº§</label>
                            <select class="form-select" id="test-priority">
                                <option value="P0">P0 - æ ¸å¿ƒå•†å“</option>
                                <option value="P1">P1 - é‡è¦å•†å“</option>
                                <option value="P2">P2 - æ™®é€šå•†å“</option>
                            </select>
                        </div>

                        <div class="col-md-6" id="category-select" style="display: none;">
                            <label class="form-label">åˆ†ç±»</label>
                            <select class="form-select" id="test-category">
                                <option value="">é€‰æ‹©åˆ†ç±»...</option>
                            </select>
                        </div>

                        <div class="col-md-6" id="product-select" style="display: none;">
                            <label class="form-label">å•†å“</label>
                            <select class="form-select" id="test-product">
                                <option value="">é€‰æ‹©å•†å“...</option>
                            </select>
                        </div>

                        <div class="col-md-6" id="test-mode-select" style="display: none;">
                            <label class="form-label">æµ‹è¯•æ¨¡å¼</label>
                            <select class="form-select" id="test-mode">
                                <option value="quick">âš¡ å¿«é€Ÿæµ‹è¯• - æ ¸å¿ƒè´­ç‰©æµç¨‹ï¼ˆ5æ­¥ï¼‰</option>
                                <option value="full">ğŸ” å…¨é¢æµ‹è¯• - å…¨é“¾è·¯åœºæ™¯è¦†ç›–ï¼ˆ12æ­¥ï¼‰</option>
                            </select>
                            <small class="text-muted">å¿«é€Ÿæµ‹è¯•éªŒè¯æ ¸å¿ƒåŠŸèƒ½ï¼Œå…¨é¢æµ‹è¯•è¦†ç›–æ‰€æœ‰åœºæ™¯</small>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="button" class="btn btn-success btn-lg" onclick="runTests()">
                            <i class="bi bi-play-circle"></i> è¿è¡Œæµ‹è¯•
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetConfig()">
                            <i class="bi bi-arrow-clockwise"></i> é‡ç½®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> å¿«é€Ÿæµ‹è¯•
            </div>
            <div class="card-body">
                <p class="text-muted small">å¿«é€Ÿæ‰§è¡Œå¸¸ç”¨æµ‹è¯•åœºæ™¯</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="runQuickTest('P0')">
                        <i class="bi bi-star"></i> P0 å¿«é€Ÿæµ‹è¯•
                    </button>
                    <button class="btn btn-warning" onclick="runQuickTest('P1')">
                        <i class="bi bi-star-half"></i> P1 å¿«é€Ÿæµ‹è¯•
                    </button>
                    <button class="btn btn-primary" onclick="runQuickTest('all')">
                        <i class="bi bi-grid"></i> å…¨é‡æµ‹è¯•
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æµ‹è¯•æ‰§è¡ŒçŠ¶æ€ -->
<div class="card mb-4" id="test-execution-card" style="display: none;">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-gear"></i> æµ‹è¯•æ‰§è¡Œä¸­</span>
            <span class="badge bg-light text-dark" id="test-elapsed-time">00:00</span>
        </div>
    </div>
    <div class="card-body">
        <!-- æ€»ä½“è¿›åº¦ -->
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span id="test-status-message">æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...</span>
                <span class="spinner-border spinner-border-sm text-primary" id="test-spinner"></span>
            </div>
            <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     id="test-progress-bar"
                     role="progressbar" style="width: 0%">
                    <span id="test-progress-text">0%</span>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æµ‹è¯•æ­¥éª¤ -->
        <div id="test-steps-container" style="display: none;">
            <h6 class="mb-3">æµ‹è¯•æ­¥éª¤è¯¦æƒ…</h6>
            <div id="test-steps-list">
                <!-- æ­¥éª¤åˆ—è¡¨å°†åŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- æ—¥å¿—è¾“å‡ºï¼ˆå¯é€‰å±•å¼€ï¼‰ -->
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleTestLogs()" id="toggle-logs-btn">
                <i class="bi bi-chevron-down"></i> æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
            </button>
            <div id="test-output-log" class="log-output mt-2" style="display: none; max-height: 300px;">
                <!-- å®æ—¶æ—¥å¿—è¾“å‡º -->
            </div>
        </div>
    </div>
</div>

<!-- æµ‹è¯•å†å² -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history"></i> æµ‹è¯•å†å²</span>
        <button class="btn btn-sm btn-outline-primary" onclick="refreshTestHistory()">
            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
        </button>
    </div>
    <div class="card-body" id="test-history-container">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let products = [];
let currentTaskId = null;
let testStartTime = null;
let timerInterval = null;

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    loadTestHistory();

    // æ£€æŸ¥URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('product_id');
    if (productId) {
        document.getElementById('test-scope').value = 'product';
        updateTestScope();
        setTimeout(() => {
            document.getElementById('test-product').value = productId;
        }, 500);
    }
});

// åŠ è½½å•†å“åˆ—è¡¨
async function loadProducts() {
    try {
        const response = await fetch('/api/products/list');
        const data = await response.json();
        products = data.products || [];

        // å¡«å……åˆ†ç±»é€‰æ‹©å™¨
        const categories = [...new Set(products.map(p => p.category).filter(c => c))];
        const categorySelect = document.getElementById('test-category');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

        // å¡«å……å•†å“é€‰æ‹©å™¨
        const productSelect = document.getElementById('test-product');
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.priority})`;
            productSelect.appendChild(option);
        });
    } catch (error) {
        console.error('åŠ è½½å•†å“å¤±è´¥:', error);
    }
}

// æ›´æ–°æµ‹è¯•èŒƒå›´
function updateTestScope() {
    const scope = document.getElementById('test-scope').value;

    document.getElementById('priority-select').style.display = 'none';
    document.getElementById('category-select').style.display = 'none';
    document.getElementById('product-select').style.display = 'none';
    document.getElementById('test-mode-select').style.display = 'none';

    if (scope === 'priority') {
        document.getElementById('priority-select').style.display = 'block';
    } else if (scope === 'category') {
        document.getElementById('category-select').style.display = 'block';
    } else if (scope === 'product') {
        document.getElementById('product-select').style.display = 'block';
        document.getElementById('test-mode-select').style.display = 'block';  // æ˜¾ç¤ºæµ‹è¯•æ¨¡å¼é€‰æ‹©
    }
}

// é‡ç½®é…ç½®
function resetConfig() {
    document.getElementById('test-scope').value = 'all';
    updateTestScope();
}

// è¿è¡Œæµ‹è¯•
async function runTests() {
    const scope = document.getElementById('test-scope').value;
    const params = {};

    if (scope === 'priority') {
        params.priority = document.getElementById('test-priority').value;
    } else if (scope === 'category') {
        const category = document.getElementById('test-category').value;
        if (!category) {
            utils.showToast('è¯·é€‰æ‹©åˆ†ç±»', 'warning');
            return;
        }
        params.category = category;
    } else if (scope === 'product') {
        const productId = document.getElementById('test-product').value;
        if (!productId) {
            utils.showToast('è¯·é€‰æ‹©å•†å“', 'warning');
            return;
        }
        params.product_id = productId;
        params.test_mode = document.getElementById('test-mode').value;  // æ·»åŠ æµ‹è¯•æ¨¡å¼
    }

    startTestExecution(params);
}

// å¿«é€Ÿæµ‹è¯•
function runQuickTest(type) {
    const params = {};
    if (type !== 'all') {
        params.priority = type;
    }
    startTestExecution(params);
}

// å¼€å§‹æµ‹è¯•æ‰§è¡Œ
async function startTestExecution(params) {
    try {
        const response = await fetch('/api/tests/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        });

        const data = await response.json();
        currentTaskId = data.task_id;

        // æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€å¡ç‰‡
        showTestExecutionCard();

        // å¼€å§‹è½®è¯¢çŠ¶æ€
        utils.pollTaskStatus(currentTaskId, updateTestStatus, onTestComplete);

    } catch (error) {
        utils.showToast('å¯åŠ¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
    }
}

// æ˜¾ç¤ºæµ‹è¯•æ‰§è¡Œå¡ç‰‡
function showTestExecutionCard() {
    const card = document.getElementById('test-execution-card');
    card.style.display = 'block';

    testStartTime = Date.now();
    updateElapsedTime();
    timerInterval = setInterval(updateElapsedTime, 1000);

    // æ»šåŠ¨åˆ°æ‰§è¡Œå¡ç‰‡
    card.scrollIntoView({ behavior: 'smooth' });
}

// éšè—æµ‹è¯•æ‰§è¡Œå¡ç‰‡
function hideTestExecutionCard() {
    document.getElementById('test-execution-card').style.display = 'none';
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// æ›´æ–°æµ‹è¯•çŠ¶æ€
function updateTestStatus(status) {
    const message = document.getElementById('test-status-message');
    const progressBar = document.getElementById('test-progress-bar');
    const progressText = document.getElementById('test-progress-text');

    // æ›´æ–°è¿›åº¦æ¡
    if (status.progress) {
        const { current, total, message: msg } = status.progress;
        if (total > 0) {
            const percentage = Math.round((current / total) * 100);
            progressBar.style.width = percentage + '%';
            progressText.textContent = percentage + '%';
        }
        if (msg) {
            message.textContent = msg;
        }
    }

    // æ›´æ–°æµ‹è¯•æ­¥éª¤æ˜¾ç¤º
    if (status.test_steps && status.test_steps.length > 0) {
        updateTestSteps(status.test_steps);
    }

    // æ›´æ–°æ—¥å¿—
    if (status.logs && status.logs.length > 0) {
        updateTestLogs(status.logs);
    }

    // æ›´æ–°çŠ¶æ€
    if (status.status === 'running') {
        message.textContent = message.textContent || 'æµ‹è¯•æ­£åœ¨æ‰§è¡Œä¸­...';
    } else if (status.status === 'completed') {
        message.textContent = 'âœ“ æµ‹è¯•æ‰§è¡Œå®Œæˆ';
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        document.getElementById('test-spinner').style.display = 'none';
    } else if (status.status === 'failed') {
        message.textContent = 'âœ— æµ‹è¯•æ‰§è¡Œå¤±è´¥';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-danger');
        document.getElementById('test-spinner').style.display = 'none';
    }
}

// æ›´æ–°æµ‹è¯•æ­¥éª¤æ˜¾ç¤º
function updateTestSteps(steps) {
    const container = document.getElementById('test-steps-container');
    const stepsList = document.getElementById('test-steps-list');

    // æ˜¾ç¤ºæ­¥éª¤å®¹å™¨
    container.style.display = 'block';

    // ç”Ÿæˆæ­¥éª¤HTML
    const html = steps.map(step => {
        let statusIcon = '';
        let statusClass = '';
        let statusBadge = '';

        if (step.status === 'passed') {
            statusIcon = 'âœ“';
            statusClass = 'border-success test-step-card';
            statusBadge = '<span class="badge bg-success">é€šè¿‡</span>';
        } else if (step.status === 'failed') {
            statusIcon = 'âœ—';
            statusClass = 'border-danger test-step-card';
            statusBadge = '<span class="badge bg-danger">å¤±è´¥</span>';
        } else if (step.status === 'skipped') {
            statusIcon = 'âŠ˜';
            statusClass = 'border-warning test-step-card';
            statusBadge = '<span class="badge bg-warning">è·³è¿‡</span>';
        } else if (step.status === 'running') {
            statusIcon = 'â‹¯';
            statusClass = 'border-primary test-step-card';
            statusBadge = '<span class="badge bg-primary"><span class="spinner-border spinner-border-sm me-1"></span>è¿›è¡Œä¸­</span>';
        } else {
            statusIcon = 'â—‹';
            statusClass = 'border-secondary test-step-card';
            statusBadge = '<span class="badge bg-secondary">å¾…æ‰§è¡Œ</span>';
        }

        let durationHtml = '';
        if (step.duration !== undefined) {
            durationHtml = `<span class="step-duration ms-2">â± ${step.duration}s</span>`;
        }

        return `
            <div class="card ${statusClass}">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <span class="step-icon">${statusIcon}</span>
                                <strong>æ­¥éª¤ ${step.number}: ${escapeHtml(step.name)}</strong>
                                ${durationHtml}
                            </div>
                            ${step.description ? `<div class="step-description">ğŸ“ ${escapeHtml(step.description)}</div>` : ''}
                            ${step.result ? `<div class="step-result">ğŸ’¡ ${escapeHtml(step.result)}</div>` : ''}
                            ${step.error ? `<div class="step-error">âš ï¸ ${escapeHtml(step.error)}</div>` : ''}
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    stepsList.innerHTML = html;
}

// æ›´æ–°æµ‹è¯•æ—¥å¿—
let lastLogCount = 0;
function updateTestLogs(logs) {
    const logsDiv = document.getElementById('test-output-log');

    if (logs.length > lastLogCount) {
        const newLogs = logs.slice(lastLogCount);
        const logsHtml = newLogs.map(log => {
            if (log.includes('ERROR') || log.includes('å¤±è´¥') || log.includes('âœ—')) {
                return `<div class="log-error">${escapeHtml(log)}</div>`;
            } else if (log.includes('SUCCESS') || log.includes('æˆåŠŸ') || log.includes('âœ“')) {
                return `<div class="log-success">${escapeHtml(log)}</div>`;
            } else if (log.includes('WARNING') || log.includes('è­¦å‘Š')) {
                return `<div class="log-warning">${escapeHtml(log)}</div>`;
            }
            return `<div>${escapeHtml(log)}</div>`;
        }).join('');

        if (lastLogCount === 0) {
            logsDiv.innerHTML = logsHtml;
        } else {
            logsDiv.insertAdjacentHTML('beforeend', logsHtml);
        }

        logsDiv.scrollTop = logsDiv.scrollHeight;
        lastLogCount = logs.length;
    }
}

// åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º
function toggleTestLogs() {
    const logsDiv = document.getElementById('test-output-log');
    const btn = document.getElementById('toggle-logs-btn');

    if (logsDiv.style.display === 'none') {
        logsDiv.style.display = 'block';
        btn.innerHTML = '<i class="bi bi-chevron-up"></i> éšè—è¯¦ç»†æ—¥å¿—';
    } else {
        logsDiv.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-chevron-down"></i> æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—';
    }
}

// æµ‹è¯•å®Œæˆ
function onTestComplete(result) {
    hideTestExecutionCard();

    if (result.status === 'completed') {
        utils.showToast('æµ‹è¯•æ‰§è¡Œå®Œæˆï¼', 'success');
    } else {
        utils.showToast('æµ‹è¯•æ‰§è¡Œå¤±è´¥', 'error');
    }

    // åˆ·æ–°æµ‹è¯•å†å²
    setTimeout(() => {
        loadTestHistory();
    }, 1000);
}

// æ›´æ–°å·²ç”¨æ—¶é—´
function updateElapsedTime() {
    if (!testStartTime) return;

    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;

    document.getElementById('test-elapsed-time').textContent =
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// åŠ è½½æµ‹è¯•å†å²
async function loadTestHistory() {
    try {
        const response = await fetch('/api/reports/list');
        const data = await response.json();
        const reports = data.reports || [];

        if (reports.length === 0) {
            utils.showEmptyState('test-history-container', 'æš‚æ— æµ‹è¯•å†å²', 'clock-history');
            return;
        }

        const html = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>æ€»æ•°</th>
                            <th>é€šè¿‡</th>
                            <th>å¤±è´¥</th>
                            <th>è·³è¿‡</th>
                            <th>é€šè¿‡ç‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reports.map(report => {
                            const summary = report.summary || {};
                            const total = summary.total || 0;
                            const passed = summary.passed || 0;
                            const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;

                            return `
                                <tr>
                                    <td>${utils.formatDateTime(report.timestamp)}</td>
                                    <td><span class="badge bg-primary">${total}</span></td>
                                    <td><span class="badge bg-success">${passed}</span></td>
                                    <td><span class="badge bg-danger">${summary.failed || 0}</span></td>
                                    <td><span class="badge bg-warning">${summary.skipped || 0}</span></td>
                                    <td>
                                        <div class="progress" style="width: 100px; height: 20px;">
                                            <div class="progress-bar ${passRate >= 90 ? 'bg-success' : passRate >= 70 ? 'bg-warning' : 'bg-danger'}"
                                                 role="progressbar" style="width: ${passRate}%">
                                                ${passRate}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="/reports" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> æŸ¥çœ‹
                                        </a>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('test-history-container').innerHTML = html;

    } catch (error) {
        console.error('åŠ è½½æµ‹è¯•å†å²å¤±è´¥:', error);
        utils.showError('test-history-container', 'åŠ è½½æµ‹è¯•å†å²å¤±è´¥');
    }
}

// åˆ·æ–°æµ‹è¯•å†å²
function refreshTestHistory() {
    utils.showLoading('test-history-container');
    loadTestHistory();
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
