name: PR Test

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'tests/**'
      - 'pages/**'
      - 'core/**'
      - 'scripts/**'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linting tools
        run: |
          pip install flake8 black isort mypy

      - name: Check code formatting with black
        run: |
          black --check --diff pages/ core/ scripts/ tests/
        continue-on-error: true

      - name: Check imports with isort
        run: |
          isort --check-only --diff pages/ core/ scripts/ tests/
        continue-on-error: true

      - name: Lint with flake8
        run: |
          flake8 pages/ core/ scripts/ tests/ --max-line-length=120 --ignore=E203,W503
        continue-on-error: true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v \
            --html=reports/pr-unit-report.html \
            --self-contained-html \
            --cov=core \
            --cov=pages \
            --cov-report=html:reports/coverage
        continue-on-error: false

      - name: Upload unit test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-unit-reports-${{ github.event.pull_request.number }}
          path: |
            reports/pr-unit-report.html
            reports/coverage/
          retention-days: 14

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Create necessary directories
        run: |
          mkdir -p data screenshots reports

      - name: Load demo product data
        run: |
          cp data/demo_products.json data/discovered_products.json || true

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v \
            --html=reports/pr-integration-report.html \
            --self-contained-html \
            --maxfail=5
        continue-on-error: false

      - name: Upload integration test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-integration-reports-${{ github.event.pull_request.number }}
          path: |
            reports/pr-integration-report.html
            screenshots/
          retention-days: 14

  e2e-smoke-tests:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: integration-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Create necessary directories
        run: |
          mkdir -p data screenshots reports

      - name: Load demo product data
        run: |
          cp data/demo_products.json data/discovered_products.json || true

      - name: Run E2E smoke tests (P0 only)
        run: |
          pytest tests/e2e/ -v \
            --priority=P0 \
            -n 2 \
            --html=reports/pr-e2e-report.html \
            --self-contained-html \
            --maxfail=3
        continue-on-error: false

      - name: Upload E2E test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-e2e-reports-${{ github.event.pull_request.number }}
          path: |
            reports/pr-e2e-report.html
            screenshots/
          retention-days: 14

  pr-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, e2e-smoke-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              lint: '${{ needs.lint.result }}',
              unit: '${{ needs.unit-tests.result }}',
              integration: '${{ needs.integration-tests.result }}',
              e2e: '${{ needs.e2e-smoke-tests.result }}'
            };

            const getEmoji = (result) => {
              if (result === 'success') return 'âœ…';
              if (result === 'failure') return 'âŒ';
              if (result === 'skipped') return 'â­ï¸';
              return 'âš ï¸';
            };

            const summary = `## ğŸ§ª PR æµ‹è¯•æŠ¥å‘Š

            | æµ‹è¯•ç±»å‹ | çŠ¶æ€ | ç»“æœ |
            |---------|------|------|
            | ä»£ç è´¨é‡æ£€æŸ¥ | ${getEmoji(results.lint)} | ${results.lint} |
            | å•å…ƒæµ‹è¯• | ${getEmoji(results.unit)} | ${results.unit} |
            | é›†æˆæµ‹è¯• | ${getEmoji(results.integration)} | ${results.integration} |
            | E2E çƒŸé›¾æµ‹è¯• | ${getEmoji(results.e2e)} | ${results.e2e} |

            **è¿è¡Œæ—¶é—´**: ${new Date().toISOString()}
            **PRç¼–å·**: #${{ github.event.pull_request.number }}

            æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: [æµ‹è¯•å·¥ä»¶](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            // æ·»åŠ è¯„è®ºåˆ° PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

      - name: Check overall status
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ] || \
             [ "${{ needs.e2e-smoke-tests.result }}" != "success" ]; then
            echo "::error::éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµ‹è¯•æŠ¥å‘Š"
            exit 1
          fi
